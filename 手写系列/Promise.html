<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    class Promise{
      constructor(executor) {
        this.status = 'pending';
        this.value = undefined;
        this.fulfillArray = []
        this.rejectedArray = []
        
        let resolve = (result) => {
          if (this.status !== 'pending') return
          queueMicrotask(() => {
            this.status = "fulfilled"
            this.value = result;
            for (let fn of this.fulfillArray) {
              fn(result)
            }
          })
        } 

        let reject = (reason) => {
          if (this.status !== 'pending') return
          queueMicrotask(() => {
            this.status = 'rejected'
            this.value = reason
            for (let fn of this.rejectedArray) {
              fn(reason)
            }
          })
        }

        try {
          executor(resolve, reject)
        } catch (error) {
          reject(error)
        }
      }

      then(onResolve, onReject) {
        if (typeof onResolve !== 'function') onResolve = (result) => result
        if (typeof onReject !== 'function') onReject = (reason) => { throw new Error(reason) }
        return new Promise((resolve, reject) => {
          this.fulfillArray.push((result) => {
            try {
                let data = onResolve(result)
                data instanceof Promise ? data.then(resolve, reject) : resolve(data)
            } catch(err) {
              reject(err)
            }
          })
          this.rejectedArray.push((reason) => {
            try {
              let data = onReject(reason)
              data instanceof Promise ? data.then(resolve, reject) : reject(data)
            } catch(err) {
              reject(err)
            }
          })
        })
      }
    }

    function MiniPromise(executor) {
      this.data = undefined;
      this.queue = []
      let self = this
      function resolve(data) {
        queueMicrotask(function() {
          self.data = data
          self.queue.forEach(fn => fn(data))
        })
      }
      executor(resolve)
    }
    MiniPromise.prototype.then = function(onResolve) {
      return new Promise((resolve) => {
        this.queue.push(() => {
          let x = onResolve(this.data)
          x instanceof MiniPromise ? x.then(resolve) : resolve(x)
        })
      })
    }
  </script>
  <script>
    let a = new MiniPromise((res => {
      setTimeout(() => {
        res(1)
      }, 3000);
    }))
    a.then(console.log)
    a.then((res) => console.log(res + 1))
    a.then((res) => console.log(res + 2))
    a.then((res) => console.log(res + 3))
  </script>
</body>
</html>